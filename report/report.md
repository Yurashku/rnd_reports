# Отчёт R&D: множественные проверки в A/B-тестах и на этапе балансировки

## Содержание
1. [Постановка задачи и контекст](#постановка-задачи-и-контекст)
2. [Ключевые вопросы](#ключевые-вопросы)
3. [Краткие выводы](#краткие-выводы)
4. [Методологические рекомендации](#методологические-рекомендации)
   1. [Финальный анализ эффекта в A/B-тесте](#финальный-анализ-эффекта-в-ab-тесте)
   2. [Проверка гомогенности после рандомизации](#проверка-гомогенности-после-рандомизации)
5. [Правильный подход к принятию решений при рерандомизации](#правильный-подход-к-принятию-решений-при-рерандомизации)
6. [Симуляция на искусственных данных](#симуляция-на-искусственных-данных)
7. [Рекомендуемый набор артефактов по итогам R&D](#рекомендуемый-набор-артефактов-по-итогам-rd)
8. [Риски и анти-паттерны](#риски-и-анти-паттерны)
9. [Список литературы](#список-литературы)

## Постановка задачи и контекст
Команда разрабатывает Python-инструмент для проведения A/B-тестов. До запуска пилота применяется этап балансировки (условно «A-тестирование»): исходная совокупность разбивается на две или более групп, после чего проверяется сопоставимость групп по предэкспериментальным признакам.

Проверка проводится набором тестов (t-test, Kolmogorov–Smirnov, χ² для категориальных переменных) по заранее зафиксированным ковариатам, включая лаговые значения целевых метрик. Если баланс неудовлетворительный, выполняется рерандомизация (повторный случайный сплит).

Возникают два методологических вопроса:
- нужна ли поправка на множественные проверки при финальном анализе A/B-теста, если целевых метрик несколько;
- нужна ли поправка на множественные проверки на этапе контроля гомогенности (до старта пилота).

## Ключевые вопросы
1. **Финальные метрики**: если в эксперименте несколько целевых метрик, контролировать ли семейную ошибку I рода (FWER/FDR)?
2. **Балансировка**: если проверок гомогенности много (по нескольким фичам и тестам), корректировать ли p-value в фильтре «принять/не принять» сплит?

## Краткие выводы
1. **Да, для финального вывода по нескольким продуктовым гипотезам поправка обычно нужна** (Bonferroni/Holm/Hochberg, либо FDR-подходы), если цель — контролировать риск ложноположительных решений на уровне набора метрик.
2. **На этапе балансировки ключевая цель — не доказательство эффектов, а контроль качества рандомизации**. Слепое применение жёстких поправок к множественным тестам гомогенности часто не решает корневую задачу и может приводить к неустойчивым правилам отбора сплитов.
3. Практически корректнее использовать **единый предзаданный критерий качества баланса** (например, порог по максимальному стандартизованному смещению SMD и/или агрегированную меру дисбаланса), лимит числа рерандомизаций и заранее зафиксированный протокол принятия решений.

## Методологические рекомендации
### Финальный анализ эффекта в A/B-тесте
Если есть несколько primary/secondary метрик, решение должно быть зафиксировано в дизайн-документе:
- определить семейство гипотез (что считается «одним выводом»);
- выбрать тип контроля ошибок:
  - **FWER** (Bonferroni/Holm) — когда критично избегать хотя бы одного ложноположительного вывода;
  - **FDR** (Benjamini–Hochberg) — когда допустима небольшая доля ложных находок в обмен на мощность;
- задать иерархию метрик (gatekeeping), если есть одна главная метрика и набор поддерживающих.

Итог: ваше предположение о необходимости поправки на этапе подведения итогов в многометриковом A/B-тесте методологически верное.

### Проверка гомогенности после рандомизации
Проверки по многим ковариатам нужны как диагностический инструмент. Но есть важные нюансы:
- p-value сильно зависит от размера выборки и числа проверок;
- при большом числе тестов даже при идеальной рандомизации «значимая» разница где-то возникнет случайно;
- if/else-логика «хотя бы один p < α → переделать сплит» может запускать избыточные рерандомизации и искажать процедуру.

Поэтому вместо фокуса на множественных p-value для ковариат предпочтительнее:
- контролировать **баланс по величине эффекта** (SMD), а не только статистическую значимость;
- использовать единый агрегированный критерий приемлемости сплита;
- ограничивать число итераций рерандомизации заранее.

Итог: идея «автоматически применять Bonferroni к тестам гомогенности» не является универсально правильной. В большинстве продуктовых сценариев лучше фиксировать критерии баланса на эффектах (SMD/махаланобисово расстояние/комбинированный скор), а p-value использовать как дополнительную диагностику.

## Правильный подход к принятию решений при рерандомизации
Ниже — практический протокол «минимально по-взрослому».

1. **До запуска эксперимента (дизайн):**
   - зафиксировать список ковариат для балансировки;
   - разделить их на приоритетные (например, лаги таргета) и вторичные;
   - определить метрику(и) дисбаланса: max |SMD|, доля ковариат с |SMD| > τ, либо агрегированный score;
   - задать пороги (например, max |SMD| ≤ 0.1 для приоритетных и ≤ 0.2 для вторичных);
   - задать лимит рерандомизаций `K_max` (например, 100–1000 в зависимости от размера задачи).

2. **Во время сплитования:**
   - генерировать случайный сплит;
   - считать критерий баланса;
   - принимать сплит, если критерий удовлетворяет порогу;
   - иначе повторять до достижения `K_max`.

3. **Если за `K_max` не найден приемлемый сплит:**
   - не «подкручивать» пороги постфактум;
   - перейти к устойчивой альтернативе:
     - стратифицированная/блочная рандомизация,
     - минимизация дисбаланса,
     - CUPED/регрессионная корректировка в итоговом анализе.

4. **В анализе результата эксперимента:**
   - учитывать факт возможной рерандомизации (документировать протокол);
   - применять заранее выбранную корректировку множественных гипотез по целевым метрикам;
   - репортить и скорректированные, и нескорректированные оценки (прозрачность).

5. **Что важно не делать:**
   - не выбирать «красивые» группы вручную;
   - не менять критерии приемки сплита после просмотра результатов;
   - не смешивать цель «баланс ковариат» с целью «доказать отсутствие различий» через серию p-value тестов.

## Симуляция на искусственных данных
В репозитории добавлен скрипт `code/simulation_balance_vs_mht.py`, который демонстрирует:
- как растет вероятность хотя бы одного «значимого» теста гомогенности при увеличении числа фичей;
- как себя ведут правила приемки сплита без коррекции, с Bonferroni и по порогу SMD.

Вывод симуляции: при росте числа проверяемых признаков правило «отклонять сплит при любом p < α» становится чрезмерно чувствительным к случайным флуктуациям; критерии на основе размеров эффекта стабильнее для инженерной балансировки.

## Рекомендуемый набор артефактов по итогам R&D
Рекомендуемый состав:
1. **Научно-практический отчёт (этот документ + PDF)**
   - постановка задачи;
   - принятые решения;
   - ограничения и риски;
   - библиография.
2. **Воспроизводимый код симуляций**
   - один скрипт с фиксированным seed;
   - CLI-параметры;
   - сохранение результатов в CSV.
3. **Артефакты вычислений**
   - таблицы итогов симуляции;
   - графики (по необходимости).
4. **README репозитория**
   - как запустить код;
   - как пересобрать отчёт;
   - где лежат результаты.

## Риски и анти-паттерны
- Риск ложной уверенности в «идеальной» гомогенности, если ориентироваться только на p-value.
- Риск деградации рандомизации при чрезмерной условной фильтрации сплитов.
- Риск невалидных выводов при отсутствии предрегистрации правил анализа и правил множественной коррекции для финальных метрик.

## Список литературы
1. Fisher, R. A. *The Design of Experiments*. Oliver & Boyd, 1935.
2. Pocock, S. J. *Clinical Trials: A Practical Approach*. Wiley, 1983.
3. Holm, S. “A Simple Sequentially Rejective Multiple Test Procedure.” *Scandinavian Journal of Statistics* 6(2), 1979.
4. Benjamini, Y., Hochberg, Y. “Controlling the False Discovery Rate: A Practical and Powerful Approach to Multiple Testing.” *JRSS B* 57(1), 1995.
5. Morgan, K. L., Rubin, D. B. “Rerandomization to Improve Covariate Balance in Experiments.” *Annals of Statistics* 40(2), 2012.
6. Lin, W. “Agnostic Notes on Regression Adjustments to Experimental Data.” *Annals of Applied Statistics* 7(1), 2013.
7. Deng, A., Knoblich, U., Lu, J. “Applying the Delta Method in Metric Analytics.” (Microsoft ExP materials), 2018.
8. Kohavi, R., Tang, D., Xu, Y. *Trustworthy Online Controlled Experiments*. Cambridge University Press, 2020.

Онлайн-ссылки:
- Morgan & Rubin (2012): https://projecteuclid.org/journals/annals-of-statistics/volume-40/issue-2/Rerandomization-to-improve-covariate-balance-in-experiments/10.1214/12-AOS1008.full
- Benjamini & Hochberg (1995): https://www.jstor.org/stable/2346101
- Holm (1979): https://www.jstor.org/stable/4615733
- Kohavi et al. (book page): https://www.cambridge.org/core/books/trustworthy-online-controlled-experiments/6B0E6B3E1D7E2AA9D2C6A5F6A8E9F0E3
