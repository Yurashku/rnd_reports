# Отчёт RnD 01

**Тема:** множественные проверки в A/B-тестах и предэкспериментальном контроле баланса (A/A), включая рекомендации по рерандомизации.  
**Контекст:** разработка Python-инструмента для A/B-экспериментов.

---

## Коротко для бизнеса (1 минута)

- Если решение о выкате может быть принято по **любой** из нескольких метрик, нужен контроль множественности (FWER/FDR), иначе растёт риск ложноположительного запуска.
- На этапе предэкспериментального контроля баланса использовать только p-value-гейтинг по множеству ковариат — плохая практика: он плохо масштабируется и создаёт лишние ложные «красные флаги».
- Для качества сплита лучше заранее фиксировать правило рерандомизации: набор ковариат, меру дисбаланса, пороги, acceptance rate, лимит попыток и правила fail-safe.
- Для продуктового инструмента рекомендуется разделить 2 независимых контура:
  1. **Контур дизайна сплита (до старта):** диагностика/ограничение дисбаланса.
  2. **Контур финального вывода (после эксперимента):** контроль ошибок множественных гипотез.

---

## 1. Постановка задачи и мотивация

В рамках разработки инструмента для A/B-тестов предусмотрен предэкспериментальный этап формирования групп (две и более) и контроля их сопоставимости по заранее выбранному набору ковариат. В набор входят лаговые значения целевых метрик и дополнительные признаки, важные для прогноза исхода.

На практике контроль сопоставимости часто реализуется как серия тестов (t-test, KS, \(\chi^2\)) по многим переменным. При росте числа проверяемых переменных увеличивается вероятность, что хотя бы одна покажет «значимое» отличие даже при корректной рандомизации. В итоге начинается цикл «сплит \(\rightarrow\) проверка \(\rightarrow\) пересэмплинг».

Отдельно стоит вопрос финального анализа по нескольким целевым метрикам: когда именно нужна поправка на множественность, и какая.

---

## 2. Вопросы исследования

- **Q1.** Нужна ли поправка на множественные проверки при подведении итогов A/B-теста по нескольким целевым метрикам?
- **Q2.** Нужна ли поправка на множественные проверки на этапе предэкспериментального контроля баланса по множеству ковариат?
- **Q3.** Если используется итеративная перегенерация разбиения до достижения «хорошего баланса» (рерандомизация), как корректно формализовать правило принятия решения и критерии остановки?

---

## 3. Выводы (кратко)

1. **Финальные итоги A/B по нескольким метрикам.**
   Нужность контроля множественности определяется правилом принятия решения. Если успех засчитывается по любой метрике из набора, нужен контроль FWER/FDR (или иерархическая схема).

2. **Контроль баланса до пилота.**
   Интерпретировать baseline-тесты как «подтверждение гомогенности через p-values» методологически нежелательно (Table 1 fallacy). Для баланса предпочтительны диагностические меры (например, SMD) и/или один заранее заданный агрегированный критерий.

3. **Рерандомизация.**
   Это корректный дизайн-подход, если заранее фиксируются: ковариаты и их приоритеты, мера дисбаланса, пороги, целевой acceptance rate, вычислительный бюджет и способ инференса с учётом дизайна.

---

## 4. Множественные сравнения в финальном A/B-анализе

### 4.1. Принцип

Проблема множественности возникает не из-за «большого числа метрик», а из-за правила решения по нескольким статистическим утверждениям.

Если проводить \(m\) независимых тестов на уровне \(\alpha\), вероятность хотя бы одного ложноположительного срабатывания:

\[
\Pr(\text{хотя бы одно ложноположительное}) = 1 - (1-\alpha)^m.
\]

### 4.2. Типовые сценарии

- **Сценарий A: «успех, если значима хотя бы одна метрика».**  
  Нужен контроль семейной ошибки (например, Holm) или заранее заданный gatekeeping.

- **Сценарий B: есть primary-метрика, secondary — вспомогательные.**  
  Строгий тест по primary на фиксированном уровне; secondary — либо с отдельной корректировкой, либо как exploratory (без влияния на решение о выкате).

- **Сценарий C: много метрик для поиска сигналов.**  
  Для screening/monitoring целесообразен FDR-контроль (Benjamini–Hochberg).

---

## 5. Контроль баланса до пилота: почему p-value-гейтинг плохо масштабируется

### 5.1. Почему baseline-significance testing нежелателен

В RCT-литературе распространена позиция: тесты значимости baseline-различий не являются проверкой «качества рандома». При корректной рандомизации различия в реализации ожидаемы как случайные флуктуации.

### 5.2. Почему поправка на множественность тут не решает корень проблемы

Bonferroni/Holm меняют частоту срабатываний гейта, но не превращают baseline-p-values в устойчивый критерий инженерного качества сплита.

При большом числе проверок \(K\) даже под нулевой гипотезой растёт шанс увидеть хотя бы одно «значимое» отличие:

\[
1 - (1-\alpha)^K.
\]

### 5.3. Практичная замена

- использовать эффект-размеры (прежде всего SMD), а не только p-value;
- использовать один агрегированный критерий (омнибус-меру), а не десятки несвязанных тестов;
- фиксировать пороги заранее по важности ковариат.

Базовая формула SMD:

\[
\mathrm{SMD}_j = \frac{\bar X_{T,j} - \bar X_{C,j}}{\sqrt{\frac{s^2_{T,j} + s^2_{C,j}}{2}}}.
\]

---

## 6. Рерандомизация: корректная логика принятия решений и остановки

### 6.1. Смысл

Рерандомизация (rejection sampling of assignments) — это элемент дизайна: назначение принимается только если удовлетворяет заранее заданному критерию баланса.

### 6.2. Рекомендуемый протокол для инструмента

1. **До генерации сплита** зафиксировать:
   - список ковариат;
   - приоритеты/веса (ключевые vs второстепенные признаки);
   - меру дисбаланса (например, Mahalanobis + ограничение на \(\max_j |\mathrm{SMD}_j|\));
   - пороги приемки;
   - целевой acceptance rate \(p_a\);
   - вычислительный бюджет (максимум попыток/тайм-лимит).

2. **Во время генерации**:
   - генерировать кандидатный сплит;
   - считать агрегированный критерий;
   - принимать сплит только при прохождении порога.

3. **Fail-safe при недостижении критерия**:
   - заранее заданная деградация (ослабление только второстепенных ограничений);
   - либо переход к блокированию/стратификации по 1–2 ключевым категориям.

4. **Воспроизводимость и аудит**:
   - логировать seed/ID назначения;
   - число отклонённых попыток;
   - значения критериев баланса;
   - причину финального выбора.

5. **Инференс после эксперимента**:
   - учитывать, что дизайн условный (назначения из подмножества, проходящего критерий);
   - применять заранее выбранный протокол анализа, включая корректировку множественности по финальным метрикам.

### 6.3. Почему это лучше, чем «Bonferroni по baseline p-values»

Подход с агрегированным критерием:

- убирает эффект «всегда найдётся одна значимая ковариата при большом \(K\)»;
- делает гейт интерпретируемым через величину дисбаланса;
- даёт управляемый компромисс «качество баланса \(\leftrightarrow\) вычислительная цена» через \(p_a\).

---

## 7. Практические следствия для Python-инструмента

### Что стоит реализовать в продукте

- Явное разделение сущностей:
  - `split_quality_policy` (дизайн и баланс до старта);
  - `inference_policy` (правила финального вывода и множественность).
- Профили правил:
  - **strict** (FWER + строгий баланс);
  - **balanced** (гибридная политика);
  - **exploratory** (FDR + мягкие ограничения на баланс).
- Журналирование всех параметров дизайна и попыток рерандомизации.

### Какие риски снимаем

- ложные отказы сплита из-за массового p-value-гейтинга;
- пост-hoc «подкручивание» порогов;
- смешение логики контроля баланса и логики статистического вывода.

---

## 8. Литература

1. de Boer M.R. et al. *Testing for baseline differences in randomized controlled trials: an unhealthy research behavior* (2015).
2. Senn S. *Testing for baseline balance in clinical trials*. Statistics in Medicine (1994).
3. Morgan K.L., Rubin D.B. *Rerandomization to improve covariate balance in experiments*. Annals of Statistics (2012).
4. FDA. *Multiple Endpoints in Clinical Trials — Guidance for Industry*.
5. Hansen B.B., Bowers J. *Covariate Balance in Simple, Stratified and Clustered Comparative Studies* (2008).
6. Austin P.C. *Balance diagnostics for comparing the distribution of baseline covariates* (2009).
7. Li X., Ding P. *Rerandomization and Regression Adjustment* (2019/2020).
8. Branson Z., Miratrix L. *Randomization Tests that Condition on Non-Categorical Covariate Balance* (2019).
9. Zhao A. et al. *No star is good news: A unified look at rerandomization* (2024).

---

## 9. Где смотреть код и воспроизводимость

- Симуляции и расчёты: `03_рерандомизация/simulation.py`.
- Ноутбуки с демонстрациями: `01_статьи_и_математика/analysis.ipynb`, `02_множественные_проверки/analysis.ipynb`, `03_рерандомизация/analysis.ipynb`, `04_план_внедрения/analysis.ipynb`.

Этот отчёт сделан как единая точка входа: бизнес-пользователю достаточно прочитать только данный файл.
