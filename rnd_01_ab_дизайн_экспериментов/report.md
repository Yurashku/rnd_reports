# RnD 01: единый отчёт по дизайну A/B-экспериментов

## 1. Цель исследования
Собрать практичный и воспроизводимый подход к проектированию A/B-экспериментов, где одновременно:
- контролируется риск ложноположительных выводов;
- сохраняется статистическая мощность;
- формализован этап предварительной балансировки групп.

## 2. Постановка задачи
В продуктовой практике есть две разные зоны принятия решений:
1. **Финальный анализ эффекта** по нескольким метрикам после эксперимента.
2. **Проверка баланса до старта** (этап рандомизации/рерандомизации).

Главный вопрос RnD: как не смешивать эти зоны и не применять p-value механически там, где нужен инженерный критерий качества сплита.

## 3. Ключевая математика (исправленный LaTeX)

### 3.1 Рост риска ложной находки при множественных проверках
Для `m` независимых тестов при уровне значимости `\alpha` вероятность хотя бы одного ложного срабатывания:

\[
P(\text{хотя бы одно FP}) = 1 - (1-\alpha)^m.
\]

Следствие: при росте числа проверок семейная ошибка I рода быстро увеличивается даже при фиксированном `\alpha` на один тест.

### 3.2 Контроль FWER через Bonferroni

\[
\alpha_{\text{per-test}} = \frac{\alpha}{m}.
\]

Это консервативный, но прозрачный механизм, когда критично избежать хотя бы одной ложноположительной продуктовой интерпретации.

### 3.3 Контроль FDR (Benjamini–Hochberg)
Для отсортированных p-value `p_{(1)} \le \dots \le p_{(m)}` находим максимальный индекс `k`, где:

\[
p_{(k)} \le \frac{k}{m} q,
\]

где `q` — допустимый уровень FDR. Отклоняются гипотезы `1..k`.

### 3.4 Критерий баланса через стандартизованное смещение
Для ковариаты `x`:

\[
\mathrm{SMD}(x)=
\frac{\bar{x}_A-\bar{x}_B}
{\sqrt{\left(s_A^2+s_B^2\right)/2}}.
\]

Практический ориентир: `|SMD| \le 0.1` для приоритетных признаков и более мягкий порог для вторичных.

## 4. Методологические выводы

### 4.1 Что делать в финальном анализе A/B
Если решение принимается по семейству метрик, коррекция множественных гипотез обязательна по заранее зафиксированному правилу:
- **Bonferroni/Holm** — когда важнее минимизировать ложные срабатывания;
- **Benjamini–Hochberg** — когда нужен баланс между ошибками и мощностью.

### 4.2 Что делать на этапе балансировки
На этапе приемки сплита не стоит строить логику только на серии p-value-тестов «на одинаковость».
Практически устойчивее:
- заранее зафиксировать единый критерий баланса (например, max `|SMD|` и/или агрегированный score);
- установить лимит рерандомизаций `K_{\max}`;
- при недостижении критерия переходить к альтернативам (стратификация, блочная рандомизация, регрессионная корректировка).

## 5. Рекомендуемый протокол принятия решения
1. **До запуска**: фиксируем метрики, семейства гипотез, тип коррекции, критерий баланса, `K_{\max}`.
2. **Во время сплитования**: генерируем случайный сплит и принимаем его только по предзаданному критерию.
3. **Если критерий не достигнут за `K_{\max}`**: используем устойчивую альтернативу, не «подкручивая» пороги постфактум.
4. **После эксперимента**: репортим как скорректированные, так и нескорректированные результаты с явным описанием протокола.

## 6. Что проверено в коде
- Теоретическая часть и базовые расчёты: `01_статьи_и_математика/analysis.ipynb`.
- Корректировки множественных гипотез: `02_множественные_проверки/analysis.ipynb`.
- Рерандомизация и сравнение правил приемки: `03_рерандомизация/analysis.ipynb`.
- Воспроизводимая CLI-симуляция: `03_рерандомизация/simulation.py`.

## 7. Итоговые практические рекомендации
- Не смешивать цель **инференса эффекта** и цель **инженерного контроля баланса**.
- Для финальных продуктовых решений всегда задавать явное семейство гипотез и правило коррекции.
- Для приемки сплита опираться на предзаданные метрики дисбаланса (например, SMD), а не на охоту за «красивыми» p-value.
- Документировать протокол до старта эксперимента и соблюдать его без ретроспективных изменений.

## 8. Ограничения и риски
- Слишком жесткая коррекция может снизить мощность и скрыть полезные сигналы.
- Слишком мягкая или отсутствующая коррекция повышает риск ложных продуктовых решений.
- Чрезмерная фильтрация сплитов при рерандомизации может исказить свойства случайного назначения.

## 9. Основные источники
1. Fisher, R. A. *The Design of Experiments* (1935).
2. Holm, S. *A Simple Sequentially Rejective Multiple Test Procedure* (1979).
3. Benjamini, Y., Hochberg, Y. *Controlling the False Discovery Rate* (1995).
4. Morgan, K. L., Rubin, D. B. *Rerandomization to Improve Covariate Balance* (2012).
5. Kohavi, R., Tang, D., Xu, Y. *Trustworthy Online Controlled Experiments* (2020).
