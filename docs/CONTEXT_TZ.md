# CONTEXT_TZ — целевое техническое задание по репозиторию R&D A/B-дизайна

- **Название проекта:** `rnd_reports` — R&D-репозиторий по дизайну A/B-экспериментов
- **Версия документа:** v0.1
- **Дата:** 2026-02-26
- **Статус:** Draft
- **Ответственный (Owner):** Staff ML/Experimentation Engineer (владелец репозитория)
- **Ключевые артефакты репозитория:**
  - `README.md`
  - `rnd_01_ab_дизайн_экспериментов/report.md`
  - `rnd_01_ab_дизайн_экспериментов/01_статьи_и_математика/analysis.ipynb`
  - `rnd_01_ab_дизайн_экспериментов/02_множественные_проверки/analysis.ipynb`
  - `rnd_01_ab_дизайн_экспериментов/03_рерандомизация/analysis.ipynb`
  - `rnd_01_ab_дизайн_экспериментов/03_рерандомизация/simulation.py`
  - `rnd_01_ab_дизайн_экспериментов/04_план_внедрения/analysis.ipynb`
  - `tools/execute_notebooks.py`, `tools/generate_pdf.py`

---

## 2. Краткое резюме (Abstract)

Репозиторий фиксирует R&D по дизайну и анализу A/B-экспериментов с фокусом на две связанные, но разные задачи: контроль баланса до старта эксперимента и контроль множественных проверок на этапе финального вывода. В текущем состоянии основной контент представлен в виде отчёта и четырёх ноутбуков внутри одного RnD (`rnd_01_ab_дизайн_экспериментов`), плюс скрипт симуляции рерандомизации и сервисные утилиты для выполнения ноутбуков и генерации PDF. Содержательно материалы уже покрывают ключевые принципы: почему p-value-гейтинг baseline-ковариат масштабируется плохо, почему при росте числа метрик/ковариат растёт вероятность ложных срабатываний, и как рерандомизация может быть формализована через заранее зафиксированный критерий приемки. 

Целевое состояние — перейти от «набора исследовательских артефактов» к воспроизводимому и расширяемому mini-framework: с модульным Python API, тестами, CI, явными контрактами, правилами качества и стабильной структурой директорий. Документ задаёт эталон: какие модули должны появиться (multiple testing, balance diagnostics, rerandomization, simulation, reporting), как они должны быть проверяемы и как измеряется готовность (Definition of Done). Также задаётся миграционный план без разрушения текущих артефактов: существующие ноутбуки остаются источником демонстраций, а логика постепенно переносится в `src/` и покрывается тестами.

---

## 3. Постановка задачи (Problem Statement)

### 3.1 Контекст A/A, A/B, контроль баланса и множественные проверки

В репозитории уже отражён практический контекст: до старта A/B-теста команда хочет убедиться в сопоставимости групп (A/A-диагностика по baseline-ковариатам), а после завершения — принять решение по одной или нескольким метрикам с корректным контролем ошибок первого рода. В `rnd_01.../report.md` зафиксирована необходимость разделять эти контуры (дизайн сплита vs инференс).

### 3.2 Почему возникает «ложная негомогенность» при большом числе ковариат

Если проверять много ковариат независимыми тестами значимости с порогом 0.05, то даже при корректной рандомизации растёт вероятность получить хотя бы одно «значимое» отличие случайно. В текущих артефактах это показано через симуляции и обсуждение рисков цикла «сплит → проверка → пересэмплинг». Следствие: p-value по отдельным ковариатам не должны быть единственным гейтом качества сплита.

### 3.3 Почему в итогах A/B возникает задача множественности

Если финальное решение о запуске функции может быть принято по любой из K метрик/эндпоинтов, то без поправки на множественные проверки резко растёт вероятность ложноположительного решения. В репозитории это отражено в блоке про FWER/FDR и в ноутбуке по множественным проверкам. Следовательно, policy финального вывода должен явно задавать стратегию (например, Holm/BH) и область её применения.

### 3.4 Ограничения и рамки

- Работа ведётся **без интернета** и без подключения внешних хранилищ.
- Данные для демонстраций и тестов должны быть синтетическими либо локальными артефактами репозитория.
- Воспроизводимость должна обеспечиваться локальным запуском (`requirements.txt`, скрипты из `tools/`, фиксированные seed).
- Репозиторий сейчас не является production-библиотекой; это R&D-база с обязательным переходом к более строгой инженерной форме.

---

## 4. Цели и не-цели

### Goals (что должно быть в финале)

1. Явно выделенный Python-пакет с модулями:
   - multiple testing,
   - balance diagnostics,
   - rerandomization,
   - simulation/reporting helpers.
2. Единые контракты API для применения в ноутбуках и скриптах.
3. Набор воспроизводимых демонстраций (ноутбуки + CLI-скрипты).
4. Автоматические тесты для ключевой математики и алгоритмов.
5. CI-пайплайн: линтеры, типизация, тесты, проверка покрытия, smoke-сборка docs.
6. Понятная документация: обзор, quickstart, контекст/ТЗ, roadmap.

### Non-goals (что сознательно не делаем)

1. Полноценный продуктовый A/B-фреймворк уровня платформы экспериментов.
2. Интеграции с конкретными DWH/feature store/трекинг-сервисами.
3. Онлайн-алгоритмы назначения пользователей в реальном времени.
4. Оркестрация production-пайплайнов и инфраструктурный деплой.

---

## 5. Термины и определения (Glossary)

- **A/A-тест:** проверка корректности процедуры назначения/анализа без истинного эффекта.
- **A/B-тест:** эксперимент с контрольной и тестовой группой для оценки эффекта.
- **Endpoint / метрика:** целевая величина, по которой принимается решение.
- **FWER (Family-Wise Error Rate):** вероятность хотя бы одной ложной значимости в семействе гипотез.
- **FDR (False Discovery Rate):** ожидаемая доля ложных среди отклонённых гипотез.
- **Holm correction:** step-down контроль FWER; обычно мощнее Bonferroni.
- **Bonferroni correction:** деление α на число проверок (консервативно).
- **BH (Benjamini–Hochberg):** процедура контроля FDR.
- **Rerandomization:** повторная генерация назначения до выполнения критерия баланса.
- **Balance diagnostics:** диагностика сопоставимости групп по ковариатам.
- **SMD (Standardized Mean Difference):** стандартизованная разность средних.
- **Mahalanobis distance:** агрегированная мера расстояния между векторами средних с учётом ковариации.
- **Gatekeeping:** иерархический порядок тестирования семейств гипотез.
- **Acceptance rate:** доля назначений, проходящих критерий рерандомизации.

---

## 6. Пользовательские сценарии (Use Cases)

1. **DS/аналитик выбирает контроль множественности**
   - Вход: вектор p-value по финальным метрикам, alpha, стратегия (`holm`/`bonferroni`/`bh`).
   - Выход: скорректированные p-value, флаги отклонения H0, резюме по семейству.

2. **DS проверяет баланс для уже сгенерированного сплита**
   - Вход: таблица baseline-ковариат и бинарный assignment.
   - Выход: отчёт по `|SMD|`, top-N дисбалансов, агрегированный score.

3. **DS запускает рерандомизацию с фиксированным policy**
   - Вход: список ковариат, веса/tiers, критерий (`max|SMD|`, Mahalanobis), `tau`/`acceptance_rate_target`, `max_iter`, seed.
   - Выход: финальное назначение + лог попыток + признак деградации policy.

4. **Исследователь воспроизводит симуляции из RnD**
   - Вход: параметры N, K, alpha, число итераций.
   - Выход: таблицы/графики роста вероятности ложных срабатываний и сравнение стратегий.

5. **Инженер добавляет новый диагностический критерий**
   - Действия: реализует функцию в `src/`, добавляет тесты в `tests/`, обновляет ноутбук-демо и документацию.
   - Критерий: все проверки CI зелёные, контракт API не нарушен.

6. **Tech Writer/ML Engineer собирает единый отчёт**
   - Вход: результаты симуляций и выводы.
   - Выход: Markdown-отчёт + PDF-экспорт по воспроизводимой команде.

---

## 7. Функциональные требования (Functional Requirements)

### 7.1 Multiple Testing module

**Минимум алгоритмов:**
- Bonferroni,
- Holm,
- BH (FDR).

**Опционально v0.2:** Hochberg, gatekeeping для семейств метрик.

**Предлагаемый API (v0.1):**

```python
adjust_pvalues(pvals: list[float], method: str, alpha: float = 0.05) -> dict
```

**Контракт:**
- Вход: `pvals` длины K (каждый в [0,1]), `method in {"bonferroni","holm","bh"}`.
- Выход (dict):
  - `adjusted_pvals: list[float]`
  - `reject: list[bool]`
  - `alpha: float`
  - `method: str`
  - `n_hypotheses: int`
- Ошибки валидации: пустой список, p-value вне диапазона, неизвестный метод.

**Пример:**
```python
res = adjust_pvalues([0.01, 0.03, 0.2], method="holm", alpha=0.05)
```

### 7.2 Balance Diagnostics module

**Метрики диагностики:**
- Для числовых: `SMD`.
- Для категориальных: разность долей по уровням + chi-square как диагностический индикатор (не как жёсткий gate).

**Агрегированные критерии:**
- `max_abs_smd` (обязательный),
- `mahalanobis_distance` (если оценка ковариационной матрицы стабильна).

**Предлагаемый API:**

```python
compute_balance_report(df, treatment_col: str, numeric_cols: list[str], categorical_cols: list[str]) -> dict
```

**Выход:**
- таблица по каждой ковариате,
- `max_abs_smd`,
- список топ-дисбалансов,
- общий статус относительно порогов policy.

### 7.3 Rerandomization module

**Правило принятия решения фиксируется заранее:**
1. Набор ковариат и их приоритеты (`weights`/`tiers`).
2. Мера дисбаланса (например, взвешенный `max|SMD|` + Mahalanobis).
3. Порог `τ` или целевой acceptance rate.
4. `max_iter`, `timeout_s`, fail-safe деградация.
5. Логирование: seed, номер попытки, значения критериев, финальный reason.

**Предлагаемый API:**

```python
rerandomize(assign_fn, X, policy, seed: int) -> dict
```

**Псевдокод:**

```text
input: X, policy, seed
set_rng(seed)
best_candidate = None
best_score = +inf

for iter in 1..max_iter:
    assignment = sample_assignment(X, policy.randomization_scheme)
    report = balance_report(X, assignment, policy.covariates)
    score = aggregate(report, policy.weights, policy.criterion)

    log(iter, score, report.max_abs_smd, report.mahalanobis)

    if score < best_score:
        best_score = score
        best_candidate = (assignment, report)

    if accept(score, policy.threshold_tau):
        return success(assignment, report, iter, degraded=False)

# fail-safe деградация
if policy.degrade_enabled:
    degraded_policy = relax_secondary_constraints(policy)
    repeat loop with remaining budget

if degraded success:
    return success(..., degraded=True)
else:
    return fallback(best_candidate, reason="max_iter_exhausted")
```

**Калибровка `τ` через acceptance rate:**
- Сгенерировать M случайных назначений на фиксированном X.
- Посчитать score для каждого.
- Взять `τ` как квантиль `q = acceptance_rate_target` распределения score.
- Зафиксировать `τ` и seed калибровки в логах.

**Остановка и деградация:**
- Hard stop: `iter >= max_iter` или `elapsed > timeout_s`.
- Degrade policy только по второстепенным ковариатам.
- Всегда возвращать лучший найденный кандидат + флаг, что строгий критерий не достигнут.

**Требования к воспроизводимости:**
- Все генераторы случайности с явным seed.
- Лог параметров и версий.
- Детеминированные результаты для одинаковых входов в пределах фиксированной версии пакета.

### 7.4 Simulation / Research module

Нужны воспроизводимые сценарии:
1. Рост `P(хотя бы один false positive)` при увеличении K.
2. Сравнение стратегий без коррекции vs Holm vs BH.
3. Влияние порога рерандомизации на баланс и число попыток.

**Формат:**
- notebook для визуализации,
- CLI-скрипт для пакетного запуска и сохранения CSV.

### 7.5 Reporting module

**Требование:**
- Генерация отчёта в Markdown + экспорт в PDF.

**Выбранный путь для v0.1:**
- Базовый встроенный экспорт через существующий `tools/generate_pdf.py` (без внешних бинарных зависимостей).
- В v0.2 — допускается миграция на `pandoc`/`typst` при наличии инфраструктуры.

**Артефакты:**
- `research_report` (научно-практический вывод),
- `tech_spec` (данный CONTEXT_TZ).

---

## 8. Нефункциональные требования (Non-Functional)

1. **Воспроизводимость:** фиксированные seed, фиксация версий в `requirements.txt`, deterministic CLI.
2. **Качество кода:** type hints, docstrings, единый стиль (ruff + black), статическая проверка (mypy на core-модули).
3. **Тестируемость:** pytest, отдельные unit-тесты для математических функций и правил корректировок.
4. **Производительность (ориентиры v0.1):**
   - `N <= 100_000`, `K <= 500` для чистой диагностики;
   - `max_iter` по умолчанию 1_000 для рерандомизации;
   - деградация должна срабатывать до полного истощения бюджета.
5. **Совместимость:** Python >= 3.10.
6. **Безопасность/конфиденциальность:** никаких PII; по умолчанию синтетика.

---

## 9. Целевая структура репозитория (Target Repository Layout)

```text
.
├── README.md
├── docs/
│   ├── CONTEXT_TZ.md
│   └── architecture.md
├── src/
│   └── ab_design_rnd/
│       ├── multiple_testing.py
│       ├── balance.py
│       ├── rerandomization.py
│       ├── simulation.py
│       └── reporting.py
├── tests/
│   ├── test_multiple_testing.py
│   ├── test_balance.py
│   ├── test_rerandomization.py
│   └── test_simulation_smoke.py
├── notebooks/
│   ├── 01_theory.ipynb
│   ├── 02_multiple_testing.ipynb
│   ├── 03_rerandomization.ipynb
│   └── 04_rollout_plan.ipynb
├── rnd_01_ab_дизайн_экспериментов/
│   └── ... (исторические артефакты первого RnD)
├── scripts/
│   ├── run_simulations.py
│   └── build_report.py
├── data/
│   └── synthetic/
├── tools/
│   ├── execute_notebooks.py
│   └── generate_pdf.py
├── requirements.txt
└── .github/workflows/ci.yml
```

**Назначение папок:**
- `src/` — переиспользуемая библиотечная логика.
- `tests/` — автоматические тесты.
- `notebooks/` — демонстрации/обучающие материалы.
- `docs/` — ТЗ, архитектурные документы, методология.
- `scripts/` — CLI-обвязки.
- `data/synthetic/` — только синтетические примеры.

**Правила именования:**
- Только `snake_case` в названиях файлов/папок для кода.
- Избегать опечаток и неоднозначностей (пример антипаттерна: `corrertions`, правильный вариант `corrections`).
- Для RnD-директорий сохранить текущий человеко-читаемый формат, но новые программные модули вести в латинице.

---

## 10. CI/CD и качество (Quality Bar)

1. **GitHub Actions (`.github/workflows/ci.yml`):**
   - `ruff check .`
   - `black --check .`
   - `mypy src/` (поэтапное включение strictness)
   - `pytest --maxfail=1 --disable-warnings --cov=src --cov-report=term-missing`
   - smoke-команда на сборку docs/report.
2. **pre-commit:** ruff + black + базовые hooks на формат.
3. **Coverage threshold:** 80% на core-модули (`multiple_testing`, `balance`, `rerandomization`).
4. **Definition of Done (чеклист):**
   - [ ] Реализация в `src/` с docstring и type hints.
   - [ ] Unit-тесты на новую/изменённую логику.
   - [ ] Ноутбуки исполнены и сохранены с output.
   - [ ] README и docs обновлены.
   - [ ] CI green.
   - [ ] В отчёте есть ссылки на код и артефакты воспроизведения.

---

## 11. План работ (Roadmap)

### Этап MVP (структуризация текущего состояния)

**Deliverables:**
- `docs/CONTEXT_TZ.md` (этот документ).
- Создание `src/`-скелета и перенос базовой логики из `simulation.py` в модульный код без изменения результатов.
- Минимальные тесты на математические примитивы (`normal_cdf`, `compute_smd`, корректировки p-value).

**Критерии:**
- Код запускается локально; результаты smoke-симуляции совпадают по порядку величин.

### Этап v0.1 (инженерное закрепление)

**Deliverables:**
- Реализованы модули `multiple_testing`, `balance`, `rerandomization`.
- Добавлены pytest и CI.
- Обновлённые ноутбуки используют функции из `src/`, а не дублируют расчёты.

**Критерии:**
- Все тесты и линтеры зелёные.
- Покрытие >= 80% для core.
- Документация содержит API-контракты и примеры CLI.

### Этап v0.2 (расширение методологии)

**Deliverables:**
- Добавлены расширенные стратегии (Hochberg/gatekeeping).
- Добавлена калибровка `tau` через acceptance-rate utility.
- Улучшенный отчётный пайплайн (по возможности typst/pandoc).

**Критерии:**
- Расширенные сценарии подтверждены тестами и демонстрациями в ноутбуках.

---

## 12. Риски и ограничения

1. **Слишком жёсткий порог баланса** → исчерпание `max_iter`.
   - Митигация: калибровка `τ` через acceptance-rate, degrade policy.
2. **Сильно коррелированные ковариаты** → нестабильная интерпретация агрегированных мер.
   - Митигация: регуляризация/ограничение набора ковариат, диагностика кондиционности.
3. **Смешение design- и inference-policy** в одном месте кода.
   - Митигация: явное разделение модулей и конфигов.
4. **Ноутбук-ориентированная разработка без тестов**.
   - Митигация: перенос логики в `src/`, ноутбуки как thin-demo слой.
5. **Непрозрачная воспроизводимость** (seed не зафиксирован, не сохраняются параметры).
   - Митигация: единый logging schema для симуляций и рерандомизации.

---

## 13. Приложения

### A. Литература и источники

Источники, уже зафиксированные в репозитории (см. `rnd_01.../report.md`):
- de Boer et al., 2015 — baseline differences in RCT.
- Senn, 1994 — baseline balance.
- Morgan & Rubin, 2012 — rerandomization.
- FDA guidance по multiple endpoints.
- Hansen & Bowers, 2008 — covariate balance.
- Austin, 2009 — balance diagnostics.
- Li & Ding, 2019/2020 — rerandomization + regression adjustment.
- Branson & Miratrix, 2019 — conditional randomization tests.
- Zhao et al., 2024 — unified look at rerandomization.

### B. Примеры CLI и псевдокод

```bash
python tools/execute_notebooks.py
python rnd_01_ab_дизайн_экспериментов/03_рерандомизация/simulation.py --n-iter 500 --n 500 --feature-grid 5,10,20,50
python tools/generate_pdf.py
```

### C. Требования к входным данным

Минимальный контракт таблицы для диагностики баланса/рерандомизации:
- `treatment` (0/1),
- числовые ковариаты (float/int),
- категориальные ковариаты (string/category),
- отсутствие PII,
- пропуски либо заранее обработаны, либо явно поддерживаются policy (в v0.2).

---

## Приложение D. Аудит текущего состояния (фактическая база)

### D1. Текущее дерево проекта (срез до уровня ~4)

```text
.
├── AGENTS.md
├── README.md
├── planned_rnd/
│   └── README.md
├── requirements.txt
├── rnd_01_ab_дизайн_экспериментов/
│   ├── 01_статьи_и_математика/analysis.ipynb
│   ├── 01_статьи_и_математика/report.md
│   ├── 02_множественные_проверки/analysis.ipynb
│   ├── 02_множественные_проверки/report.md
│   ├── 03_рерандомизация/analysis.ipynb
│   ├── 03_рерандомизация/report.md
│   ├── 03_рерандомизация/report.pdf
│   ├── 03_рерандомизация/report_for_pdf.txt
│   ├── 03_рерандомизация/simulation.py
│   ├── 03_рерандомизация/simulation_results.csv
│   ├── 04_план_внедрения/analysis.ipynb
│   ├── 04_план_внедрения/report.md
│   ├── README.md
│   ├── codex_prompts/prompts_codex.md
│   ├── codex_prompts/report.md
│   └── report.md
└── tools/
    ├── execute_notebooks.py
    └── generate_pdf.py
```

### D2. Что реализовано в ноутбуках

1. `01_статьи_и_математика/analysis.ipynb`
   - Заголовок: «RnD 01: теоретическая база».
   - Код: базовый расчёт вероятности ложных срабатываний (`alpha = 0.05`) и вывод.

2. `02_множественные_проверки/analysis.ipynb`
   - Заголовок: «RnD 02: корректировки для финальных метрик».
   - Код: демонстрационный расчёт с `alpha = 0.05` и пояснением по корректировкам.

3. `03_рерандомизация/analysis.ipynb`
   - Заголовок: «RnD 03: рерандомизация и баланс».
   - Код: примерные вычисления при `alpha = 0.05` и практическая рекомендация.

4. `04_план_внедрения/analysis.ipynb`
   - Заголовок: «RnD 04: операционный шаблон внедрения».
   - Код: структурированный план шагов внедрения (`steps = [...]`).

### D3. Существующие Python-скрипты и публичные функции

1. `03_рерандомизация/simulation.py`
   - `normal_cdf`, `welch_pvalue`, `compute_smd`, `simulate_once`, `run_simulation`, `save_csv`, `parse_args`, `main`.

2. `tools/execute_notebooks.py`
   - `execute_notebook`, `main`.

3. `tools/generate_pdf.py`
   - `escape_pdf_text`, `split_pages`, `build_content_stream`, `make_pdf`, `main`.

### D4. Проблемы текущего состояния (факты)

1. Нет package-структуры `src/`.
2. Нет `tests/` и автотестов.
3. Нет CI/CD-конфигурации (`.github/workflows`).
4. Нет `pyproject.toml`/настроек линтеров и типизации.
5. Ноутбуки и код разделены слабо; API как библиотеки отсутствует.
6. Нейминг директорий смешивает русские названия и кодовую логику — неудобно для импорта.
7. Логика симуляции сосредоточена в одном скрипте, без модульного разделения.
8. В `tools/generate_pdf.py` docstring на английском, что не единообразно с русскоязычным стандартом репозитория.
9. Воспроизводимость есть на базовом уровне, но не формализована как контракт (нет structured logs, нет тестов детерминизма).
10. Нет единого техдокумента с целевой архитектурой и DoD (закрывается этим файлом).
11. В `requirements.txt` только минимальные зависимости, но без dev-инструментов качества.
12. Наличие `planned_rnd/` указывает на масштабирование, но отсутствует формальный governance-процесс качества.

### D5. Текущее состояние в 10–20 буллетах

1. Репозиторий уже содержит один завершённый RnD-пакет по A/B-дизайну.
2. Основной вход для читателя — `rnd_01.../report.md`.
3. Есть 4 ноутбука, покрывающих теорию, множественные проверки, рерандомизацию и план внедрения.
4. Есть Python-скрипт симуляции рерандомизации с сохранением CSV.
5. Есть утилита массового выполнения ноутбуков.
6. Есть утилита локальной генерации PDF без внешних зависимостей.
7. Структура рассчитана на human-readable отчёты, но не на пакетное переиспользование кода.
8. Автоматических тестов пока нет.
9. CI/CD отсутствует.
10. Нет явно выделенного слоя API/доменных сущностей.
11. Репозиторий хорошо описывает методологию на уровне текстов.
12. Репозиторий слабо формализует инженерные гарантии качества.
13. Сценарий масштабирования на следующие RnD предусмотрен (`planned_rnd`), но без технического каркаса.
14. Документация на русском и в целом согласована со стилевым требованием.
15. Текущее состояние подходит для research-коммуникации, но требует миграции для production-grade reproducibility.

---

## Target RnD layout

Целевой формат репозитория фиксирован:

- в корне должны быть ровно 4 RnD-директории:
  - `01_bonferroni_aa_matching/`
  - `02_pyspark_fast_aa/`
  - `03_autoconfig_homogeneity_split/`
  - `04_faiss_matcher_tradeoff/`
- в каждой из 4 директорий должно быть ровно 3 файла:
  - `notebook.ipynb`
  - `report.md`
  - `report.pdf`
- любые вспомогательные скрипты, CI и утилиты должны лежать только вне этих 4 директорий (например, `tools/`, `scripts/`, `.github/`, `docs/`).
- `report.pdf` обязан пересобираться автоматически из `report.md`.
