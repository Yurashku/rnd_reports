# RnD-1: Поправки на множественные проверки в A/A-контроле баланса и в итогах A/B, связь с мэтчингом

**Статус:** Draft  
**Область:** A/B эксперименты, pre-check (A/A), балансировка/мэтчинг

## 1. Контекст и постановка

В экспериментальной платформе есть два разных по смыслу блока проверок:

1) **Итоговый анализ A/B** по одной или нескольким целевым метрикам (endpoints), по которым принимается решение о внедрении.

2) **Предэкспериментальный контроль разбиения** (часто называемый A/A), где проверяется сопоставимость групп по набору ковариат (включая лаги таргета и вспомогательные признаки). Иногда это реализовано как множество тестов (t-test/KS/χ²) с порогом по p-value. При «плохом» результате выполняется перегенерация разбиения (рерандомизация).

Проблема: при росте числа ковариат вероятность «хотя бы одного значимого отличия» быстро растёт даже при корректной рандомизации. Это провоцирует лишние итерации и создаёт ложное ощущение «некачественного сплита».

## 2. Вопросы

- Q1. Нужна ли поправка на множественные проверки при подведении итогов A/B по нескольким целевым метрикам?
- Q2. Нужна ли поправка на множественные проверки при контроле баланса до пилота, если используется p-value-гейтинг по многим ковариатам?
- Q3. Как корректно формализовать accept/reject в рерандомизации и не превратить процесс в «p-hacking на сплитах»?
- Q4. Как это связано с мэтчингом и ковариатной корректировкой?

## 3. Выводы

### 3.1 Итоги A/B по нескольким метрикам: поправка обычно нужна

Если правило успеха устроено как **«успех, если значима хотя бы одна из m метрик»**, то без контроля множественности растёт вероятность ложноположительного «успеха» на уровне эксперимента. В таких случаях требуется заранее выбрать стратегию контроля ошибок:

- FWER: Bonferroni / Holm (когда цена ложного успеха высока),
- FDR: Benjamini–Hochberg (когда метрик много и анализ скорее exploratory),
- либо иерархия endpoints (primary → secondary).

Если заранее зафиксирована **primary-метрика**, по которой принимается решение, а вторичные метрики не используются для “катим/не катим”, то жёсткая поправка для вторичных может быть не нужна (при дисциплине pre-registration дизайна).

### 3.2 Контроль баланса до пилота: p-values не являются хорошим критерием «гомогенности»

Baseline-p-values зависят от N и не измеряют величину дисбаланса. При большом числе ковариат ложные «срабатывания» ожидаемы даже при идеальном рандоме. Поэтому попытка «лечить» проблему поправкой на множественность в baseline-тестах (например, Bonferroni) — чаще инженерная регулировка жёсткости гейта, а не корректная статистическая постановка.

Рекомендуемый подход: баланс как **диагностика** (effect size), а accept/reject строить через **один агрегированный критерий** дисбаланса.

### 3.3 Рерандомизация: корректное правило принятия решения

Рерандомизация (rejection sampling of assignments) должна быть частью дизайна эксперимента:

1) До генерации разбиений фиксируем список ковариат и их приоритеты (tiers/weights).
2) Выбираем метрику дисбаланса (например, max|SMD| по ключевым ковариатам; опционально агрегированная дистанция).
3) Выбираем порог τ **проспективно**, предпочтительно через целевую долю принятых разбиений (acceptance rate p_a, например 1–10%).
4) Ограничиваем бюджет: max_iter / time-limit.
5) Fail-safe: если max_iter исчерпан — смягчаем требования только по low-priority ковариатам или переходим к стратификации по 1–2 ключевым категориям.
6) Логируем: seed, число попыток, значения критерия.

## 4. Рекомендации для реализации в библиотеке

1) **Итоги A/B:** добавить опции Holm / Bonferroni / BH-FDR, поддержку иерархии endpoints (primary -> secondary).
2) **Pre-check (A/A):** заменить «гейт по множеству p-values» на:
   - отчёт по SMD/разностям долей (диагностика),
   - агрегированный критерий принятия (например max|SMD| по top-covariates).
3) **Рерандомизация:** формализовать API: criterion, threshold/acceptance_rate, max_iter, tiers/weights, seed, обязательное логирование.

## 5. План экспериментов на синтетике (для notebook.ipynb)

- Рост вероятности «хотя бы одного ложного флага» при росте числа ковариат K при нулевом эффекте.
- Сравнение частоты ложных флагов: без коррекции vs Bonferroni vs Holm vs BH.
- Сравнение числа итераций рерандомизации и качества баланса:
  - p-value-гейт (как baseline),
  - max|SMD|-гейт (как рекомендуемый вариант).

## 6. Литература

- FDA. *Multiple Endpoints in Clinical Trials: Guidance for Industry* (Oct 2022).  
  https://www.fda.gov/regulatory-information/search-fda-guidance-documents/multiple-endpoints-clinical-trials
- de Boer et al. (2015). *Testing for baseline differences in randomized controlled trials: an unhealthy research behavior that is hard to eradicate.*  
  https://pmc.ncbi.nlm.nih.gov/articles/PMC4310023/
- Senn S. (1994). *Testing for baseline balance in clinical trials.* Stat Med. DOI: 10.1002/sim.4780131703.  
  https://pubmed.ncbi.nlm.nih.gov/7997705/
- Benjamini Y., Hochberg Y. (1995). *Controlling the False Discovery Rate...* DOI: 10.1111/j.2517-6161.1995.tb02031.x  
  https://doi.org/10.1111/j.2517-6161.1995.tb02031.x
